document.addEventListener("DOMContentLoaded",function(a){function b(a){for(a=a.trim();a.charCodeAt(0)<=32;)a=a.substr(1);a=a.trim();var b;if(window.DOMParser){var c=new DOMParser;b=c.parseFromString(a,"text/xml")}else b=new ActiveXObject("Microsoft.XMLDOM"),b.async=!1,b.loadXML(a);return b}var c=document.getElementById("fileInput"),d=document.getElementsByClassName("menuButton");d[2].onclick=c.click.bind(c),c.onchange=function(){if(console.log("CHANGED"),1!=c.files.length||!c.files[0].name.match(/.*\.ipar$/))return void alert("You must select an IPAR file to convert!");if(confirm("Are you sure you want to convert this case file? You will lose all save data current inside it!")){for(var a=0;a<d.length;a++)d[a].disabled=!0;var e=new FileReader;e.onload=function(){console.log("READ"),JSZip.loadAsync(e.result).then(function(a){console.log("UNZIPPED");var d={},e=1,f=0,g=function(){if(++f>=e){console.log(d);var a=d.caseFile.getElementsByTagName("case")[0];if(Number(a.getAttribute("version"))>=1)return void alert("Can only convert case's from before version 1!");a.setAttribute("version","1.0");for(var b=a.getElementsByTagName("resourceList")[0].getElementsByTagName("resource"),g=0;g<b.length;g++)0==Number(b[g].getAttribute("type"))&&b[g].setAttribute("link",d.resourceLinks[b[g].getAttribute("link")]);for(var h=a.getElementsByTagName("button"),g=0;g<h.length;g++)console.log(d.imageLinks[h[g].getAttribute("imageLink").replace(/\//g,"\\")]+":"+h[g].getAttribute("imageLink").replace(/\//g,"\\")),h[g].setAttribute("imageLink",d.imageLinks[h[g].getAttribute("imageLink").replace(/\//g,"\\")]);d.saveFile.getElementsByTagName("questions")[0].innerHTML="",d.saveFile.getElementsByTagName("case")[0].setAttribute("caseStatus",0);var i=new JSZip;i.file("caseFile.ipardata",(new XMLSerializer).serializeToString(d.caseFile)),i.file("saveFile.ipardata",(new XMLSerializer).serializeToString(d.saveFile)),i.folder("submitted"),i.generateAsync({type:"base64"}).then(function(a){var b=document.createElement("a");b.style.display="none",b.href="data:application/zip;base64,"+a,b.download=c.files[0].name,document.body.appendChild(b),b.click(),document.body.removeChild(b),window.location.reload()})}};e++,a.file("case\\active\\caseFile.ipardata").async("string").then(function(a){d.caseFile=b(a),g()}),e++,a.file("case\\active\\saveFile.ipardata").async("string").then(function(a){d.saveFile=b(a),g()});var h=a.folder("case\\assets\\images");d.imageLinks={};for(var i in h.files)h.files.hasOwnProperty(i)&&!i.endsWith("/")&&i.substr(0,i.lastIndexOf("\\"))==h.root.substr(0,h.root.length-1)&&(e++,function(b){a.file(b).async("arraybuffer").then(function(a){var c=new FormData;c.append("image",new Blob([a],{type:getMimeType(b)}),b.substring(b.lastIndexOf("\\")+1));var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(d.imageLinks[b.substring(b.indexOf("\\")+1)]=window.location.href.substr(0,window.location.href.lastIndexOf("/"))+"/image/"+e.responseText,g())},e.open("POST","image.php",!0),e.send(c)})}(i));var j=a.folder("case\\assets\\files");d.resourceLinks={};for(var i in j.files)j.files.hasOwnProperty(i)&&!i.endsWith("/")&&i.substr(0,i.lastIndexOf("\\"))==j.root.substr(0,j.root.length-1)&&(e++,function(b){a.file(b).async("arraybuffer").then(function(a){var c=new FormData;c.append("resource",new Blob([a],{type:getMimeType(b)}),b.substring(b.lastIndexOf("/")+1));var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(d.resourceLinks[b.substring(b.lastIndexOf("\\")+1)]=window.location.href.substr(0,window.location.href.lastIndexOf("/"))+"/resource/"+e.responseText,g())},e.open("POST","resource.php",!0),e.send(c)})}(i));g()})},e.readAsArrayBuffer(c.files[0])}}});